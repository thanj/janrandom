#!/usr/bin/env ruby

# == Synopsis
#   Janrain Random User Generator
#   Blah blah blah.
#
# == Examples
#   Initialize your app for random user generation:
#   (This will prompt you for Capture domain, client id, and secret,
#   and save those credentials, as well as the app schema in a config file)
#     jrug init myapp
#
#   Create 100 random users in your Janrain Capture app
#     jrug create myapp 100
#
#   Uncreate all random users created with this script:
#     jrug uncreate myapp
#
#   Remove the "jrugIsAutoGenerated" flag from the app schema:
#     jrug uninit myapp
#
# == Usage
#   jrug create {app} [number]
#
#   For help use: jrug -h
#
# == Options
#   -h, --help          Displays help message
#   -v, --version       Display the version, then exit
#   -q, --quiet         Output as little as possible, overrides verbose
#   -V, --verbose       Verbose output
#   TO DO - add additional options
#
# == Author
#   Janrain
#
# == Copyright
#   Copyright (c) 2013 Janrain. Licensed under the MIT License:
#   http://www.opensource.org/licenses/mit-license.php

require 'thor'
require 'highline/import'
require 'yaml'
require 'rest_client'
require 'faker'
require 'terminal-table'

class Jrug < Thor
  option :verbose, :type => :boolean


  desc "apps", "display a list of Capture apps configured for jrug"
  def apps()
    read_options

    puts 'Apps available to JRUG:'
    @apps.each_key { |key| puts key }
  end


  desc "init APP", "set up APP for random-user generation"
  def init(app)
    read_options

    if @apps && @apps.has_key?(app)
      puts 'Using credentials from .appconfig file...'
      appoptions = @apps[app]
    else
      puts "Enter credentials for #{app}..."
      appoptions = Hash.new
      appoptions[:server]       = ask("Capture Server?  ") { |q| q.default = app }
      appoptions[:clientid]     = ask("Client ID?       ") { |q| q.default = "none" }
      appoptions[:clientsecret] = ask("Client Secret?   ") { |q| q.echo    = "x" }
      @apps[app] = appoptions
      File.open('.appconfig', 'w') { |f| YAML.dump(@apps, f) }
    end

    entityType = RestClient.post( "https://#{appoptions[:server]}/entityType",
      {
        :client_id     => appoptions[:clientid],
        :client_secret => appoptions[:clientsecret],
        :type_name     => 'user'
      }
    )

    attrDefs = JSON.parse( entityType )

    @schema = { }
    parse_attr_defs( attrDefs['schema']['attr_defs'] )

    # If there's no "jrugIsAutoGenerated" attribute in the schema, add it now
    unless @schema.has_key?('jrugIsAutoGenerated')
      RestClient.post( "https://#{appoptions[:server]}/entityType.addAttribute",
        {
          :client_id     => appoptions[:clientid],
          :client_secret => appoptions[:clientsecret],
          :type_name     => 'user',
          :attr_def      => '{"name":"jrugIsAutoGenerated","type":"string","length":1}'
        }
      )
    end

    @apps[app][:schema] = @schema
    File.open('.appconfig', 'w') { |f| YAML.dump(@apps, f) }

    puts "Successfully prepared app #{app} for random user generation."
  end


  desc "create APP [NUMBER]", "create NUMBER (defaults to 10) dummy users for the Capture app APP"
  def create(app, number = 10)
    read_options

    unless @apps.has_key?(app)
      puts "#{app} has not been initialized to JRUG yet. Try running `jrug init #{app}` first."
      exit
    end

    puts "Creating #{number} randomized users for #{app}:"

    table = Terminal::Table.new do |t|
      number.to_i.times do
        first_name = Faker::Name.first_name
        last_name = Faker::Name.last_name
        email = Faker::Internet.email([first_name,last_name].join(' '))
        current_location = Faker::Address.city + ', ' + Faker::Address.state
        t << [first_name, last_name, email, current_location]
      end
    end

    puts table
  end


  no_commands {
    def read_options
      if File.exist?(".appconfig")
        @apps = YAML::load( File.open( ".appconfig" ) )
      else
        @apps = { }
      end
    end

    def parse_attr_defs( entity, depth = false )
      entity.each { |attr|
        if attr['name']
          if attr['type']
            if depth
              return attr['type']
            else
              @schema[ attr['name'] ] = attr['type']
            end
          end
          if attr['attr_defs']
            @schema[ attr['name'] ] = parse_attr_defs( attr['attr_defs'], "#{depth}#{attr['name']}." )
          end
        end
      }
    end
  }


end


# TO DO - Add your Modules, Classes, etc


# Create and run the application
Jrug.start(ARGV)
